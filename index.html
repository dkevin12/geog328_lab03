<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Video Game Companies</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body, html { margin: 0; padding: 0; height: 100%; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  #side-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: rgba(255,255,255,0.9);
    overflow-y: auto;
    padding: 15px;
  }

  h2 { margin-top: 0; text-align: center; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
  }
  th, td {
    text-align: left;
    padding: 6px;
    border-bottom: 1px solid #ccc;
  }
  th {
    cursor: pointer;
    background: #f2f2f2;
  }

  @media (max-width: 1024px) {
    #side-panel { display: none; }
  }
</style>
</head>

<body>
<div id="map"></div>

<div id="side-panel">
  <h2>Video Game Companies</h2>
  <table id="companyTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Company</th>
        <th onclick="sortTable(1)">Country</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>Console Manufacturers</h3>
  <canvas id="hardwareChart" width="280" height="200"></canvas>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGtldmluMTIiLCJhIjoiY21oZHVvN29uMDc5MjJscHU4b2EwdmN4bCJ9.bXVDUdRmBTBy3WQcf8iyiw';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [0, 20],
  zoom: 1.5
});

Promise.all([
  fetch('assets/companies.geojson').then(res => res.json()),
  fetch('assets/hardware.geojson').then(res => res.json())
]).then(([companies, hardware]) => {

  companies.features.forEach(feature => {
    const { name, country } = feature.properties;
    new mapboxgl.Marker({ color: "#0078FF" })
      .setLngLat(feature.geometry.coordinates)
      .setPopup(new mapboxgl.Popup().setText(`${name} (${country})`))
      .addTo(map);

    const row = document.createElement('tr');
    row.innerHTML = `<td>${name}</td><td>${country}</td>`;
    document.querySelector('#companyTable tbody').appendChild(row);
  });

  hardware.features.forEach(feature => {
    const { name, country } = feature.properties;
    new mapboxgl.Marker({ color: "#FF5733" })
      .setLngLat(feature.geometry.coordinates)
      .setPopup(new mapboxgl.Popup().setText(`${name} (${country})`))
      .addTo(map);
  });

  const countryCount = {};
  hardware.features.forEach(f => {
    const c = f.properties.country;
    countryCount[c] = (countryCount[c] || 0) + 1;
  });

  const ctx = document.getElementById('hardwareChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(countryCount),
      datasets: [{
        label: 'Console Manufacturers',
        data: Object.values(countryCount),
        backgroundColor: 'rgba(255, 87, 51, 0.6)',
        borderColor: 'rgba(255, 87, 51, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: false,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}).catch(err => console.error('Error loading GeoJSON files:', err));

function sortTable(n) {
  const table = document.getElementById("companyTable");
  let switching = true, dir = "asc";
  while (switching) {
    switching = false;
    const rows = table.rows;
    for (let i = 1; i < rows.length - 1; i++) {
      let shouldSwitch = false;
      const x = rows[i].getElementsByTagName("TD")[n];
      const y = rows[i + 1].getElementsByTagName("TD")[n];
      if ((dir === "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) ||
          (dir === "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) {
        shouldSwitch = true;
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        break;
      }
    }
    if (!switching && dir === "asc") { dir = "desc"; switching = true; }
  }
}
</script>
</body>
</html>
